// Generated by LiveScript 1.5.0
(function(){
  var Logger, Search, slice$ = [].slice;
  Logger = require('../logger');
  module.exports = Search = (function(){
    Search.displayName = 'Search';
    var prototype = Search.prototype, constructor = Search;
    importAll$(prototype, arguments[0]);
    function Search(arg$){
      var ref$;
      this.console = arg$.console, this.callCallback = arg$.callCallback, this.callback = arg$.callback, this.options = arg$.options, this.parsed = arg$.parsed, this.parserOptions = arg$.parserOptions, this.results = (ref$ = arg$.results) != null
        ? ref$
        : [], this.opts = arg$.opts;
      this.searchResults = {};
      this.searchResults.data = [];
      this.searchResults.format = 'default';
      this.out = function(it){
        this.searchResults.data.push(it);
        if (this.callCallback) {
          this.callback(it);
        }
      };
    }
    setCount(function(){
      var that;
      return this.count = (that = this.options.maxCount) != null
        ? min(that, this.results.length)
        : this.results.length;
    });
    setResults(function(){
      this.searchResults.sorted = sortWith(this.searchResults.sortFunc, this.results);
      return this.searchResults.sliced = slice$.call(this.searchResults.sorted, 0, count);
    });
    replacePairs(function(){
      return this.options.to || this.options.inPlace;
    });
    handleReplacement(function(){
      var replaced, e;
      if (this.replacement == null) {
        return;
      }
      try {
        replaced = replace(this.replacement, this.cleanInput, this.searchResults.sliced, this.queryEngine);
        if (this.replacePairs != null) {
          constructor.searchResults.format = 'pairs';
          return this.out([name, replaced]);
        } else {
          return this.out(replaced);
        }
      } catch (e$) {
        e = e$;
        return this.error(name + ": Error during replacement. " + e.message + ".");
      }
    });
    handleDisplayFilename(function(){
      if (!this.options.displayFilename) {
        return;
      }
      if (this.options.json || this.data) {
        constructor.searchResults.format = 'pairs';
        return this.out([this.name, this.count]);
      } else {
        return this.out(formatCount(this.color, this.count, this.name));
      }
    });
    countData(function(){
      return this.out(this.options.json || this.data
        ? this.count
        : formatCount(this.color, this.count));
    });
    handleCount(function(){
      if (!this.options.count) {
        return;
      }
      return this.handleDisplayFilename() || this.countData();
    });
    isMatching(function(){
      return this.options.filesWithMatches && this.count || this.options.filesWithoutMatch && !this.count;
    });
    handleFileMatching(function(){
      if (!(this.options.filesWithoutMatch || this.options.filesWithMatches)) {
        return;
      }
      if (this.isMatching != null) {
        return this.out(this.options.json || this.data
          ? this.name
          : formatName(this.color, this.name));
      }
    });
    handlePairs(function(){
      if (!this.options.displayFilename) {
        return;
      }
      this.searchResults.format = 'pairs';
      return this.out([this.name, this.searchResults.sliced]);
    });
    handleLists(function(){
      this.searchResults.format = 'lists';
      return this.out(this.searchResults.sliced);
    });
    handleJsonData(function(){
      if (!(this.options.json || this.data)) {
        return;
      }
      return this.handlePairs() || this.handleLists();
    });
    handleInputData(function(){
      var i$, ref$, len$, result, results$ = [];
      this.inputLines = lines(this.cleanInput);
      for (i$ = 0, len$ = (ref$ = this.searchResults.sliced).length; i$ < len$; ++i$) {
        result = ref$[i$];
        results$.push(this.out(formatResult(this.name, this.inputLines, this.inputLines.length, textFormatFuncs, this.options, this.result)));
      }
      return results$;
    });
    handleData(function(){
      return this.handleJsonData() || this.handleInputData();
    });
    parseInput(function(){
      var e;
      this.cleanInput = this.input.replace(/^#!.*\n/, '');
      try {
        this.time("parse-input:" + name);
        this.parsed.input = parser.parse(this.cleanInput, parserOptions);
        this.timeEnd("parse-input:" + name);
        if (this.options.printAst) {
          return this.log(JSON.stringify(this.parsed.input, null, 2));
        }
      } catch (e$) {
        e = e$;
        throw new Error("Error: Could not parse JavaScript from '" + name + "'. " + e.message);
      }
    });
    query(function(){
      this.time("query:" + name);
      this.results = this.queryEngine.queryParsed(this.parsed.selector, this.parsed.input);
      return this.timeEnd("query:" + name);
    });
    search(Search.name, Search.input)(function(){
      this.time("search-total:" + name);
      this.parseInput();
      this.query();
      this.setCount();
      this.setResults();
      this.handleReplacement() || this.handleCount() || this.handleFileMatching() || handleData();
      this.timeEnd("search-total:" + name);
    });
    return Search;
  }(Logger));
  function importAll$(obj, src){
    for (var key in src) obj[key] = src[key];
    return obj;
  }
}).call(this);
